// ==UserScript==
// @name         GeoGuessr State Streak
// @description  Adds a state/province/region streak counter that automatically updates while you play (may not work for all countries, depending on how they define their regions)
// @version      1.30
// @author       miraclewhips
// @match        *://*.geoguessr.com/*
// @icon         https://www.google.com/s2/favicons?domain=geoguessr.com
// @grant        unsafeWindow
// @run-at       document-start
// @copyright    2022, miraclewhips (https://github.com/miraclewhips)
// @license      MIT
// @downloadURL  https://github.com/miraclewhips/geoguessr-userscripts/raw/master/geoguessr-state-streak.user.js
// @updateURL    https://github.com/miraclewhips/geoguessr-userscripts/raw/master/geoguessr-state-streak.user.js
// ==/UserScript==

/* ------------------------------------------------------------------------------- */
/* ----- SETTINGS (MUST RELOAD PAGE FOR CHANGES TO TAKE EFFECT) ------------------ */
/* ------------------------------------------------------------------------------- */
const LANGUAGE = "en";   // ISO 639-1 language code - https://en.wikipedia.org/wiki/List_of_ISO_639-1_codes
const CHALLENGE = true;  // Set to false to disable streaks on challenge links
const AUTOMATIC = true;  // Set to false for a manual counter (controlled by keyboard shortcuts only)

/* ------------------------------------------------------------------------------- */
/* ----- KEYBOARD SHORTCUTS (MUST RELOAD PAGE FOR CHANGES TO TAKE EFFECT) -------- */
/* ------------------------------------------------------------------------------- */
const KEYBOARD_SHORTCUTS = {
	reset: '0',     // reset streak to 0
	increment: '1', // increment streak by 1
	decrement: '2', // decrement streak by 1
	restore: '8',   // restore your streak to it's previous value
};



/* ############################################################################### */
/* ##### DON'T MODIFY ANYTHING BELOW HERE UNLESS YOU KNOW WHAT YOU ARE DOING ##### */
/* ############################################################################### */

if(window.frameElement) return;

// Event Framework
(function() {
var __awaiter=this&&this.__awaiter||function(c,R,t,i){function o(n){return n instanceof t?n:new t(function(s){s(n)})}return new(t||(t=Promise))(function(n,s){function l(r){try{u(i.next(r))}catch(a){s(a)}}function v(r){try{u(i.throw(r))}catch(a){s(a)}}function u(r){r.done?n(r.value):o(r.value).then(l,v)}u((i=i.apply(c,R||[])).next())})};const THE_WINDOW=unsafeWindow||window;(function(){class c{constructor(){this.events=new EventTarget,this.state=this.defaultState(),this.loadState(),this.initFetchEvents(),this.overrideFetch(),this.init(),THE_WINDOW.addEventListener("load",()=>{var t,i,o;if(location.pathname.startsWith("/challenge/")){const n=(o=(i=(t=THE_WINDOW?.__NEXT_DATA__)===null||t===void 0?void 0:t.props)===null||i===void 0?void 0:i.pageProps)===null||o===void 0?void 0:o.gameSnapshot;if(!n||!n.round)return;THE_WINDOW.GEFFetchEvents.dispatchEvent(new CustomEvent("received_data",{detail:n}))}}),THE_WINDOW.GEFFetchEvents.addEventListener("received_data",t=>{this.parseData(t.detail)})}initFetchEvents(){THE_WINDOW.GEFFetchEvents===void 0&&(THE_WINDOW.GEFFetchEvents=new EventTarget)}overrideFetch(){if(THE_WINDOW.fetch.isGEFFetch)return;const t=THE_WINDOW.fetch;THE_WINDOW.fetch=function(){return function(...i){var o;return __awaiter(this,void 0,void 0,function*(){const n=i[0].toString();if(n.match(/geoguessr\.com\/api\/v3\/games$/)&&((o=i[1])===null||o===void 0?void 0:o.method)==="POST"){const s=yield t.apply(THE_WINDOW,i),l=yield s.clone().json();return l.round&&THE_WINDOW.GEFFetchEvents.dispatchEvent(new CustomEvent("received_data",{detail:l})),s}if(/geoguessr.com\/api\/v3\/(games|challenges)\//.test(n)&&n.indexOf("daily-challenge")===-1){const s=yield t.apply(THE_WINDOW,i),l=yield s.clone().json();return l.round&&THE_WINDOW.GEFFetchEvents.dispatchEvent(new CustomEvent("received_data",{detail:l})),s}return t.apply(THE_WINDOW,i)})}}(),THE_WINDOW.fetch.isGEFFetch=!0}init(){return __awaiter(this,void 0,void 0,function*(){return this.loadedPromise||(this.loadedPromise=Promise.resolve(this)),yield this.loadedPromise})}defaultState(){return{current_game_id:"",is_challenge_link:!1,current_round:0,round_in_progress:!1,game_in_progress:!0,total_score:{amount:0,unit:"points",percentage:0},total_distance:{meters:{amount:0,unit:"km"},miles:{amount:0,unit:"miles"}},total_time:0,rounds:[],map:{id:"",name:""}}}parseData(t){const i=t.player.guesses.length==t.round,o=t.round!==this.state.current_round||t.token!==this.state.current_game_id;i?this.stopRound(t):o&&this.startRound(t)}loadState(){let t=window.localStorage.getItem("GeoGuessrEventFramework_STATE");if(!t)return;let i=JSON.parse(t);i&&(Object.assign(this.state,this.defaultState(),i),this.saveState())}saveState(){window.localStorage.setItem("GeoGuessrEventFramework_STATE",JSON.stringify(this.state))}hex2a(t){const i=t.toString();let o="";for(let n=0;n<i.length;n+=2)o+=String.fromCharCode(parseInt(i.substring(n,n+2),16));return o}startRound(t){this.state.current_round=t.round,this.state.round_in_progress=!0,this.state.game_in_progress=!0,this.state.current_game_id=t.token,this.state.is_challenge_link=t.type=="challenge",this.state.rounds=this.state.rounds.slice(0,t.round-1),t&&(this.state.map={id:t.map,name:t.mapName}),this.saveState(),this.state.current_round===1&&this.events.dispatchEvent(new CustomEvent("game_start",{detail:this.state})),this.events.dispatchEvent(new CustomEvent("round_start",{detail:this.state}))}stopRound(t){var i,o,n,s,l,v,u,r,a,h,m,_,p,f,g,E,F,w,y,S,G,k,T,C,D,x,I,N,O,b;if(this.state.round_in_progress=!1,t){const d=t.rounds[this.state.current_round-1],e=t.player.guesses[this.state.current_round-1];if(!d||!e)return;this.state.rounds[this.state.current_round-1]={location:{lat:d.lat,lng:d.lng,heading:d.heading,pitch:d.pitch,zoom:d.zoom,panoId:d.panoId?this.hex2a(d.panoId):void 0},player_guess:{lat:e.lat,lng:e.lng},score:{amount:parseFloat((i=e?.roundScore)===null||i===void 0?void 0:i.amount)||0,unit:((o=e?.roundScore)===null||o===void 0?void 0:o.unit)||"points",percentage:((n=e?.roundScore)===null||n===void 0?void 0:n.percentage)||0},distance:{meters:{amount:parseFloat((l=(s=e?.distance)===null||s===void 0?void 0:s.meters)===null||l===void 0?void 0:l.amount)||0,unit:((u=(v=e?.distance)===null||v===void 0?void 0:v.meters)===null||u===void 0?void 0:u.unit)||"km"},miles:{amount:parseFloat((a=(r=e?.distance)===null||r===void 0?void 0:r.miles)===null||a===void 0?void 0:a.amount)||0,unit:((m=(h=e?.distance)===null||h===void 0?void 0:h.miles)===null||m===void 0?void 0:m.unit)||"miles"}},time:e?.time},this.state.total_score={amount:parseFloat((p=(_=t?.player)===null||_===void 0?void 0:_.totalScore)===null||p===void 0?void 0:p.amount)||0,unit:((g=(f=t?.player)===null||f===void 0?void 0:f.totalScore)===null||g===void 0?void 0:g.unit)||"points",percentage:((F=(E=t?.player)===null||E===void 0?void 0:E.totalScore)===null||F===void 0?void 0:F.percentage)||0},this.state.total_distance={meters:{amount:parseFloat((S=(y=(w=t?.player)===null||w===void 0?void 0:w.totalDistance)===null||y===void 0?void 0:y.meters)===null||S===void 0?void 0:S.amount)||0,unit:((T=(k=(G=t?.player)===null||G===void 0?void 0:G.totalDistance)===null||k===void 0?void 0:k.meters)===null||T===void 0?void 0:T.unit)||"km"},miles:{amount:parseFloat((x=(D=(C=t?.player)===null||C===void 0?void 0:C.totalDistance)===null||D===void 0?void 0:D.miles)===null||x===void 0?void 0:x.amount)||0,unit:((O=(N=(I=t?.player)===null||I===void 0?void 0:I.totalDistance)===null||N===void 0?void 0:N.miles)===null||O===void 0?void 0:O.unit)||"miles"}},this.state.total_time=(b=t?.player)===null||b===void 0?void 0:b.totalTime,this.state.map={id:t.map,name:t.mapName}}this.saveState(),this.events.dispatchEvent(new CustomEvent("round_end",{detail:this.state})),this.state.current_round===5&&this.events.dispatchEvent(new CustomEvent("game_end",{detail:this.state}))}}THE_WINDOW.GeoGuessrEventFramework||(THE_WINDOW.GeoGuessrEventFramework=new c,console.log("GeoGuessr Event Framework initialised: https://github.com/miraclewhips/geoguessr-event-framework"))})();
})();

// Streak Framework
(function() {
var __awaiter=this&&this.__awaiter||function(d,e,t,s){function i(a){return a instanceof t?a:new t(function(n){n(a)})}return new(t||(t=Promise))(function(a,n){function r(u){try{o(s.next(u))}catch(c){n(c)}}function l(u){try{o(s.throw(u))}catch(c){n(c)}}function o(u){u.done?a(u.value):i(u.value).then(r,l)}o((s=s.apply(d,e||[])).next())})};const CC_DICT={AX:"FI",AS:"US",AI:"GB",AW:"NL",BM:"GB",BQ:"NL",BV:"NO",IO:"GB",KY:"UK",CX:"AU",CC:"AU",CK:"NZ",CW:"NL",FK:"GB",FO:"DK",GF:"FR",PF:"FR",TF:"FR",GI:"UK",GL:"DK",GP:"FR",GU:"US",GG:"GB",HM:"AU",HK:"CN",IM:"GB",JE:"GB",MO:"CN",MQ:"FR",YT:"FR",MS:"GB",AN:"NL",NC:"FR",NU:"NZ",NF:"AU",MP:"US",PS:"IL",PN:"GB",PR:"US",RE:"FR",BL:"FR",SH:"GB",MF:"FR",PM:"FR",SX:"NL",GS:"GB",SJ:"NO",TK:"NZ",TC:"GB",UM:"US",VG:"GB",VI:"US",WF:"FR",EH:"MA"};class GeoGuessrStreakFramework{constructor(e){if(this.options=e,this.state=this.defaultState(),this.current_round=0,this.should_update_round_panel=!1,this.should_update_summary_panel=!1,typeof this.options.storage_identifier=="string"&&(this.options.storage_identifier=this.options.storage_identifier.replace(/[^\w\d-_]/g,""),this.options.storage_identifier.length==0))throw new Error("'storage_identifier' must not be blank and can only contain letters, digits, underscores, and hyphens.");const t={storage_identifier:"geoguessr-streak-framework",name:"Country Streak",terms:{single:"country",plural:"countries"},enabled_on_challenges:!0,automatic:!0,language:"en",streak_type:"round",only_match_country_code:!0,query_openstreetmap:!0,address_matches:["country"],keyboard_shortcuts:{increment:"1",decrement:"2",reset:"0",restore:"8"}};this.options=Object.assign(t,this.options),this.loadState(),this.setupKeyboardShortcuts(),window.addEventListener("load",this.updateStreakPanels.bind(this));const s=unsafeWindow||window;if(!s.GeoGuessrEventFramework)throw new Error("GeoGuessr Streak Framework requires GeoGuessr Event Framework (https://github.com/miraclewhips/geoguessr-event-framework). Please include this before you include GeoGuessr Streak Framework.");this.events=s.GeoGuessrEventFramework,this.events.init().then(i=>{console.log("GeoGuessr Streak Framework initialised.");const a=()=>{let n=document.querySelector("#__next");if(!n)return;new MutationObserver(this.checkState.bind(this)).observe(n,{subtree:!0,childList:!0}),i.events.addEventListener("round_start",o=>{this.current_round=o.detail.current_round,this.should_update_round_panel=!0,this.updateStreakPanels()});const l=this.options.streak_type==="game"?"game_end":"round_end";i.events.addEventListener(l,o=>{this.should_update_summary_panel=!0,this.stopRound(o.detail)})};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",a):a()})}defaultState(){return{checking_api:!1,streak:0,previous_streak:0,streak_backup:0,guess_name:null,location_name:null,last_guess_identifier:null}}loadState(){this.state=this.defaultState();let e=JSON.parse(window.localStorage.getItem(this.options.storage_identifier));e&&(e.checking_api=!1,Object.assign(this.state,e),this.saveState())}saveState(){window.localStorage.setItem(this.options.storage_identifier,JSON.stringify(this.state))}getRoundPanel(){return document.getElementById(`streak-counter-panel-${this.options.storage_identifier}`)}getSummaryPanel(){return document.getElementById(`streak-score-panel-summary-${this.options.storage_identifier}`)}updateRoundPanel(){if(!this.getRoundPanel()){let s=document.querySelector('div[class^="game_status__"] div[class^="status_section"][data-qa="score"]');if(s){let i=document.createElement("div");i.id=`streak-counter-panel-${this.options.storage_identifier}`,i.style.display="flex";let a=s.querySelector('div[class^="status_label"]').className,n=s.querySelector('div[class^="status_value"]').className;i.innerHTML=`<div class="${s.getAttribute("class")}"><div class="${a}">${this.options.name.toUpperCase()}</div><div id="streak-counter-value-${this.options.storage_identifier}" class="${n}"></div></div>`,s.parentNode.append(i)}}let t=document.getElementById(`streak-counter-value-${this.options.storage_identifier}`);t&&(t.innerText=this.state.streak.toString())}createStreakText(){if(this.state.checking_api)return"Loading...";if(this.state.streak>0)return this.state.guess_name||this.state.location_name?`It was <span style="color:#6cb928">${this.state.guess_name||this.state.location_name}!</span> ${this.options.name}: <span style="color:#fecd19">${this.state.streak}</span>`:`${this.options.name}: <span style="color:#fecd19">${this.state.streak}</span>`;{let e=`${this.options.terms.plural} in a row.`;switch(this.state.previous_streak){case 1:e=`${this.options.terms.single}.`}let t="";return this.state.guess_name&&this.state.location_name&&(t=`You guessed <span style="color:#f95252">${this.state.guess_name}</span>, unfortunately it was <span style="color:#6cb928">${this.state.location_name}</span>.`),`${t} Your streak ended after <span style="color:#fecd19">${this.state.previous_streak}</span> ${e}`}}createStreakElement(){let e=document.createElement("div");return e.style.fontSize="18px",e.style.fontWeight="500",e.style.color="#fff",e.style.padding="10px",e.style.paddingBottom="0",e.style.background="var(--ds-color-purple-100)",e}updateSummaryPanel(){if(this.options.streak_type==="game"&&this.current_round!==5)return;const e=document.querySelector('div[class^="result-layout_root"] div[class^="round-result_wrapper__"]'),t=document.querySelector('div[class^="result-layout_root"] div[class^="result-layout_bottomNew__"]');if(t&&(t.style.flex="0",t.style.maxHeight="none"),!e&&!t)return;let s=this.getSummaryPanel();e&&!s&&(s=this.createStreakElement(),s.id=`streak-score-panel-summary-${this.options.storage_identifier}`,e.parentNode.insertBefore(s,e)),s&&(s.innerHTML=this.createStreakText())}updateStreakPanels(){this.updateRoundPanel(),this.updateSummaryPanel()}queryOSM(e){return __awaiter(this,void 0,void 0,function*(){let t=`https://nominatim.openstreetmap.org/reverse.php?lat=${e.lat}&lon=${e.lng}&zoom=18&format=jsonv2&accept-language=${this.options.language}`;return yield fetch(t).then(s=>s.json())})}isAutoStreakDisabled(e){return!this.options.automatic||e.is_challenge_link&&!this.options.enabled_on_challenges}matchCountryCode(e){var t;let s=(t=e?.country_code)===null||t===void 0?void 0:t.toUpperCase();return s?CC_DICT[s]||s:null}matchAddress(e){if(e&&this.options.address_matches&&this.options.address_matches.length>0){for(let t of this.options.address_matches)if(e[t])return e[t]}return"Undefined"}stopRound(e){return __awaiter(this,void 0,void 0,function*(){if(this.isAutoStreakDisabled(e))return;this.updateStreakPanels();const t=e.rounds[e.current_round-1];if(!t)return;const s=`${e.current_game_id}-${e.current_round}`;if(s==this.state.last_guess_identifier){this.updateStreakPanels();return}if(this.state.last_guess_identifier=s,this.saveState(),t.location.lat==null||t.location.lng==null||t.player_guess.lat==null||t.player_guess.lng==null){this.state.guess_name=null,this.state.location_name=null,this.setStreakValue(0);return}let i=!1;if(this.state.checking_api=!0,this.options.query_openstreetmap){this.updateStreakPanels();const a=yield this.queryOSM(t.player_guess),n=yield this.queryOSM(t.location);if(this.options.custom_match_function){const r=yield this.options.custom_match_function(this.events.state,a,n);this.state.checking_api=!1,this.state.guess_name=r.player_guess_name,this.state.location_name=r.actual_location_name,i=r.match}else{this.state.checking_api=!1;const r=this.matchCountryCode(a?.address),l=this.matchCountryCode(n?.address);this.state.guess_name=this.matchAddress(a?.address),this.state.location_name=this.matchAddress(n?.address);const o=r&&l&&r===l,u=this.state.guess_name===this.state.location_name;i=o&&(u||this.options.only_match_country_code)}}else{const a=yield this.options.custom_match_function(this.events.state,t.player_guess,t.location);this.state.checking_api=!1,this.state.guess_name=a.player_guess_name,this.state.location_name=a.actual_location_name,i=a.match}this.updateStreakPanels(),i?this.incrementStreakValue(1):this.setStreakValue(0)})}checkStreakIsLatest(){let e=JSON.parse(window.localStorage.getItem(this.options.storage_identifier));e&&(this.state.streak=e.streak)}incrementStreakValue(e){this.checkStreakIsLatest(),this.setStreakValue(this.state.streak+e)}setStreakValue(e){this.checkStreakIsLatest(),this.state.previous_streak=this.state.streak,this.state.streak=e,this.state.streak!==0&&(this.state.streak_backup=this.state.streak),this.saveState(),this.updateStreakPanels()}setupKeyboardShortcuts(){let e=this.options.keyboard_shortcuts;document.addEventListener("keypress",t=>{if(!(!this.getRoundPanel()&&!this.getSummaryPanel()))switch(t.key){case e.reset:this.setStreakValue(0);break;case e.increment:this.incrementStreakValue(1);break;case e.decrement:this.incrementStreakValue(-1);break;case e.restore:this.setStreakValue(this.state.streak_backup+1);break}})}checkState(){const e=document.querySelector('div[class^="in-game_root__"]');if(!e)return;const t=document.querySelector('div[class^="game_status__"]'),s=document.querySelector('div[class^="round-result_wrapper__"]'),i=document.querySelector('div[class^="result-layout_root__"] div[class^="result-overlay_overlayContent__"]'),a=this.should_update_round_panel||!this.getRoundPanel(),n=this.should_update_summary_panel||!this.getSummaryPanel();e&&(t&&a?(this.should_update_round_panel=!1,this.updateRoundPanel()):(s||i)&&n&&(this.should_update_summary_panel=!1,this.updateSummaryPanel()))}}(unsafeWindow||window).GeoGuessrStreakFramework=GeoGuessrStreakFramework;
})();

const GSF = new (unsafeWindow || window)['GeoGuessrStreakFramework']({
	storage_identifier: 'MW_GeoGuessrStateStreak',
	name: 'State Streak',
	terms: {
		single: 'state',
		plural: 'states'
	},
	enabled_on_challenges: CHALLENGE,
	automatic: AUTOMATIC,
	language: LANGUAGE,
	only_match_country_code: false,
	address_matches: ['state', 'territory', 'province', 'county', 'municipality', 'ISO3166-2-lvl4'],
	keyboard_shortcuts: KEYBOARD_SHORTCUTS,
});
